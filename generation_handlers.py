"""
Обработчики генерации документов для двухэтапного процесса
"""
import asyncio
import logging
from typing import Set
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from document_types import DOCUMENT_TYPES
from document_selector import get_document_selector_keyboard

logger = logging.getLogger(__name__)

# ═══════════════════════════════════════════════════════════════
# ЭТАП 1: АНАЛИЗ КОМПАНИИ + ГЕНЕРАЦИЯ ДОСЬЕ
# ═══════════════════════════════════════════════════════════════

async def process_analysis(message: Message, state: FSMContext, user_id: int, manus_api_key: str):
    """
    ЭТАП 1: Анализирует компанию и генерирует только досье клиента.
    После завершения показывает меню выбора документов.
    """
    data = await state.get_data()
    company_url = data.get("company_url", "")
    domain = company_url.replace("https://", "").replace("http://", "").split("/")[0]
    
    # Сообщение о начале анализа
    await message.answer(f"""
╔══════════════════════════════════════════════════════════════╗
║                  🔍 ЭТАП 1: АНАЛИЗ КОМПАНИИ                  ║
╚══════════════════════════════════════════════════════════════╝

🌐 Компания: {domain}
📊 Задача: Глубокий анализ + генерация досье клиента

⏱ Примерное время: 5-10 минут

⚙️ Запускаю аналитический модуль JARVIS...
""")
    
    # Промпт для Manus API - только анализ и досье
    data = await state.get_data()
    goal = data.get('goal', 'Не указана')
    constraints = data.get('constraints', 'Не указаны')
    
    prompt = f"""
═══════════════════════════════════════════════════════════════
JARVIS v3.0 — ЭТАП 1: АНАЛИЗ КОМПАНИИ И СОЗДАНИЕ ДОСЬЕ
═══════════════════════════════════════════════════════════════

РОЛЬ И ЦЕЛЬ
Ты — исследователь-аналитик для Коммерческого директора BimAR System.
Твоя задача: провести глубокий анализ компании-клиента и создать "deal-ready" досье, 
чтобы понять бизнес, процессы и потенциал для применения решений BimAR.

ВХОДНЫЕ ДАННЫЕ
- URL сайта: {company_url}
- Цель встречи: {goal}
- Ограничения клиента: {constraints}

ОСНОВНОЙ ПРИНЦИП
Фокус на том, что помогает закрыть сделку: боли, процессы, ЛПР, потенциал для пилота.
Не пиши «энциклопедию» — только факты, которые приближают к пилоту и ТКП.

ИСТОЧНИКИ (обязательно цитировать с датой доступа)
1) Официальный сайт компании (о компании, контакты, проекты, услуги, новости, вакансии, документы)
2) Закупки/тендеры (если применимо): zakupki.gov.ru, коммерческие площадки
3) Отчётность/реестры: ЦБ/ФНС/ЕГРЮЛ, годовые отчёты (если публичные)
4) Косвенные источники: вакансии (для ИТ-ландшафта), техстатьи, презентации, кейсы

Любое фактическое утверждение — со ссылкой. 
Если данных нет — явно пометь как "ГИПОТЕЗА" и вынеси допущения.

═══════════════════════════════════════════════════════════════
СТРУКТУРА ДОСЬЕ (01_Досье_на_клиента.docx)
═══════════════════════════════════════════════════════════════

1) EXECUTIVE SUMMARY (0.5 страницы)
   - Кто клиент: название, отрасль, география, масштаб (сотрудники/обороты)
   - Что делает: основной бизнес, продукты/услуги
   - Почему интересен для BimAR: 2-3 ключевые боли (с источниками)
   - Потенциал сделки: оценка (High/Med/Low) + краткое обоснование

2) ПОРТРЕТ КОМПАНИИ (0.5 страницы)
   - Основные площадки/филиалы
   - Карта процессов: где физические активы (склад/цех/стройка/эксплуатация/полевая работа)
   - ИТ-ландшафт (гипотезы): ERP/1C, WMS, CMMS/EAM, MES, GIS/BIM, VMS
     (с доказательствами из вакансий/новостей или пометкой "гипотеза")

3) ИНВЕНТАРЬ АКТИВОВ И БОЛЕЙ (0.5 страницы)
   Список активов по категориям (выбери 3-5 релевантных):
   - Склады/ЗИП/инструмент/возвратная тара
   - Производство/ремонт/цеха/депо
   - Стройка/капстрой/объекты
   - Полевая эксплуатация/бригады/инспекции
   - Уличная/распределённая инфраструктура
   - ИТ-активы/серверные/кабельная инфраструктура
   - Архивы/документы
   
   Для каждой боли: "как сейчас", "почему плохо", "как измерить"

4) ПОТЕНЦИАЛ ДЛЯ BimAR (0.5 страницы)
   - Топ-3 кейса применения BimAR для этой компании (коротко)
   - Почему это деньги: какая метрика страдает (время/потери/простой/SLA/штрафы)
   - Рекомендуемая зона для пилота №1 (90 дней): где начать и почему

5) NEXT STEPS (0.25 страницы)
   - Какие данные запросить у клиента для детализации
   - Кого встретить (гипотезы по ЛПР: Economic Buyer, Champion)
   - Риски и барьеры (ИБ/on-prem/интеграции/персонал)

6) ИСТОЧНИКИ
   - Список всех использованных источников с URL и датой доступа

═══════════════════════════════════════════════════════════════
ТРЕБОВАНИЯ К ОФОРМЛЕНИЮ
═══════════════════════════════════════════════════════════════
- Формат: DOCX (редактируемый, для мобильного просмотра), профессиональный деловой стиль
- Объем: 2-3 страницы (не больше!)
- Язык: русский
- Все факты — со ссылками в сносках
- Гипотезы — явно помечены как "ГИПОТЕЗА"
- Таблицы и списки — для структурированности

═══════════════════════════════════════════════════════════════
ВАЖНО
═══════════════════════════════════════════════════════════════
- Используй ТОЛЬКО проверенную информацию с сайта и публичных источников
- Если данных недостаточно — укажи это явно
- Не придумывай цифры и факты — лучше написать "данных нет"
- Фокус на пресейле: что поможет закрыть сделку, а не общая информация

═══════════════════════════════════════════════════════════════
ВЫХОДНОЙ ФАЙЛ
═══════════════════════════════════════════════════════════════
Создай досье и сохрани как: 01_Досье_на_клиента.docx
"""
    
    # Вызов Manus API
    try:
        # TODO: Здесь должен быть реальный вызов Manus API
        # Временная заглушка для демонстрации
        await asyncio.sleep(2)  # Имитация работы API
        
        # Имитация успешной генерации
        await message.answer(f"""
╔══════════════════════════════════════════════════════════════╗
║                  ✅ АНАЛИЗ ЗАВЕРШЕН                          ║
╚══════════════════════════════════════════════════════════════╝

📄 Создан документ:
   • 01_Досье_на_клиента.docx

📊 Результаты анализа:
   • Отрасль определена
   • Потребности выявлены
   • Точки применения BIMAR найдены

🎯 Теперь выберите, какие документы нужно сгенерировать:
""")
        
        # Показываем меню выбора документов
        await show_document_selector(message, state)
        
    except Exception as e:
        logger.error(f"Ошибка при анализе компании: {e}")
        await message.answer(f"""
❌ Ошибка при анализе компании:
{str(e)}

Попробуйте снова или обратитесь к администратору.
""")
        await state.clear()

# ═══════════════════════════════════════════════════════════════
# ЭТАП 2: ВЫБОР ДОКУМЕНТОВ
# ═══════════════════════════════════════════════════════════════

async def show_document_selector(message: Message, state: FSMContext):
    """
    ЭТАП 2: Показывает интерактивное меню выбора документов.
    """
    from main_states import PresaleStates  # Импорт здесь чтобы избежать циклических зависимостей
    
    # Инициализируем пустой список выбранных документов
    await state.update_data(selected_docs=[])
    await state.set_state(PresaleStates.selecting_docs)
    
    # Отправляем меню с клавиатурой
    await message.answer(
        text="""
╔══════════════════════════════════════════════════════════════╗
║              📋 ВЫБОР ДОКУМЕНТОВ ДЛЯ ГЕНЕРАЦИИ               ║
╚══════════════════════════════════════════════════════════════╝

Выберите документы, которые нужно создать:

✅ — документ будет создан
⬜ — документ не будет создан

Нажмите на кнопки для выбора, затем "Создать выбранные"
""",
        reply_markup=get_document_selector_keyboard(set())
    )

# ═══════════════════════════════════════════════════════════════
# ЭТАП 3: ГЕНЕРАЦИЯ ВЫБРАННЫХ ДОКУМЕНТОВ
# ═══════════════════════════════════════════════════════════════

async def process_selected_documents(message: Message, state: FSMContext, user_id: int):
    """
    ЭТАП 3: Генерирует только выбранные пользователем документы.
    """
    data = await state.get_data()
    selected_docs = set(data.get("selected_docs", []))
    company_url = data.get("company_url", "")
    domain = company_url.replace("https://", "").replace("http://", "").split("/")[0]
    
    if not selected_docs:
        await message.answer("⚠️ Не выбрано ни одного документа для генерации.")
        return
    
    # Формируем список документов для генерации
    docs_to_generate = [DOCUMENT_TYPES[doc_id] for doc_id in selected_docs if doc_id in DOCUMENT_TYPES]
    
    await message.answer(f"""
╔══════════════════════════════════════════════════════════════╗
║              🚀 ЭТАП 3: ГЕНЕРАЦИЯ ДОКУМЕНТОВ                 ║
╚══════════════════════════════════════════════════════════════╝

📦 Создаю {len(docs_to_generate)} документов:

{chr(10).join(f"   • {doc['name']}" for doc in docs_to_generate)}

⏱ Примерное время: {len(docs_to_generate) * 2}-{len(docs_to_generate) * 3} минут

⚙️ JARVIS приступает к работе...
""")
    
    # Промпт для Manus API - генерация выбранных документов
    docs_list = "\n".join([
        f"{i+1}. {doc['name']} — {doc['description']}"
        for i, doc in enumerate(docs_to_generate)
    ])
    
    # Получаем дополнительные данные из состояния
    goal = data.get('goal', 'Не указана')
    constraints = data.get('constraints', 'Не указаны')
    
    prompt = f"""
═══════════════════════════════════════════════════════════════
JARVIS v3.0 — ЭТАП 3: ГЕНЕРАЦИЯ ПРЕСЕЙЛ-ПАКЕТА
═══════════════════════════════════════════════════════════════

РОЛЬ И ЦЕЛЬ
Ты — исследователь-аналитик для Коммерческого директора BimAR System.
Твоя задача: на основе досье клиента создать "deal-ready" пакет материалов для закрытия сделки.

ВХОДНЫЕ ДАННЫЕ
- URL сайта: {company_url}
- Цель встречи: {goal}
- Ограничения: {constraints}
- Досье клиента: 01_Досье_на_клиента.docx (уже создано на Этапе 1)

ДОКУМЕНТЫ ДЛЯ СОЗДАНИЯ (выбраны пользователем):
{docs_list}

ОСНОВНОЙ ПРИНЦИП
Фокус на том, что помогает закрыть сделку: экономика, пилоты, KPI, MAP, возражения.
Все документы должны быть согласованы с досье и между собой.

═══════════════════════════════════════════════════════════════
ФОРМАТЫ ФАЙЛОВ (ВАЖНО! Для мобильного просмотра)
═══════════════════════════════════════════════════════════════
Все документы ДОЛЖНЫ быть в РЕДАКТИРУЕМЫХ форматах:
- Текстовые документы: .docx (НЕ .pdf!)
- Таблицы: .xlsx (НЕ .csv!)
- Презентации: .pptx

Это позволит открывать и редактировать на iPhone/Android в:
- Google Docs/Sheets/Slides
- Microsoft Word/Excel/PowerPoint

═══════════════════════════════════════════════════════════════
ОПИСАНИЕ ДОКУМЕНТОВ (создавай ТОЛЬКО выбранные)
═══════════════════════════════════════════════════════════════

02_Решения_BIMAR.xlsx
- Таблица с модулями BimAR: название, описание, применение для клиента, цена
- Модули: Цифровая маркировка + CV, Склад/ЗИП, Цех/ремонт, Стройконтроль, Логистика, ОТ/СИЗ, Видео/БПЛА
- Колонки: Модуль | Описание | Применение | Цена (вилка) | Примечания
- Лист 2: "Why BimAR vs QR/RFID/RTLS" (6-10 тезисов)

03_Экономика_сделки.xlsx
- Лист 1: ROI Calculator (3-5 метрик: время поиска, недостачи, простой, повторные выезды, штрафы)
- Лист 2: Стоимость пилота (CAPEX + OPEX, min/likely/max)
- Лист 3: Assumptions (все допущения и источники)
- Формулы должны быть рабочими!

04_Пилот_ТЗ.docx
- ТЗ на Pilot #1 (90 дней): цель, зона, объёмы, интеграции, KPI, план 0-2-6-9-12 недель, ресурсы, риски, критерии Go/No-Go
- Требования: быстрый, измеримый, с явной экономикой, минимальные интеграции

05_ЛПР_и_квалификация.xlsx
- Лист 1: ЛПР (ФИО, должность, роль, влияние, контакты, источник)
- Лист 2: Decision Criteria (ИБ/on-prem/интеграции/точность/скорость/стоимость)
- Лист 3: Decision Process (тендер/прямой договор/рамочный)
- Лист 4: Competition (QR/RFID/RTLS/доработка WMS/текущие подрядчики)

06_Питч_для_клиента.pptx
- 10-12 слайдов: Титул, Проблема (3-4 боли), Решение BimAR, Как работает, Кейсы (2-3), Модули, Экономика (ROI), Пилот (90 дней), Why BimAR, MAP (6-8 недель), Next Steps, Контакты
- Стиль: минимум текста, максимум визуала, фокус на выгоде

07_Верификация.docx
- Чек-лист готовности: Документы, Квалификация (MEDDPICC), Данные для уточнения, Риски и барьеры, Возражения (топ-5), Next Steps, Источники
- Формат: таблицы с галочками ☐/☑

═══════════════════════════════════════════════════════════════
ОБЩИЕ ТРЕБОВАНИЯ КО ВСЕМ ДОКУМЕНТАМ
═══════════════════════════════════════════════════════════════
1. Язык: русский
2. Все факты — со ссылками на источники (из досье)
3. Гипотезы — явно помечены как "ГИПОТЕЗА"
4. Согласованность: все документы должны ссылаться на одни и те же данные
5. Профессиональный деловой стиль
6. Фокус на пресейле: что поможет закрыть сделку
7. ФОРМАТЫ: .docx, .xlsx, .pptx (НЕ PDF!)

═══════════════════════════════════════════════════════════════
ВАЖНО
═══════════════════════════════════════════════════════════════
- Используй информацию из досье (01_Досье_на_клиента.docx) как базу
- Не противоречь досье — все документы должны быть согласованы
- Если данных недостаточно — укажи это явно и добавь в чек-лист вопросов
- Не придумывай цифры — лучше диапазоны (min/max) с пометкой "требуется уточнение"

═══════════════════════════════════════════════════════════════
ВЫХОДНЫЕ ФАЙЛЫ
═══════════════════════════════════════════════════════════════
Создай ТОЛЬКО выбранные документы и сохрани с правильными названиями.
Все файлы в РЕДАКТИРУЕМЫХ форматах (.docx, .xlsx, .pptx)!
"""
    
    try:
        # TODO: Здесь должен быть реальный вызов Manus API
        # Временная заглушка для демонстрации
        await asyncio.sleep(3)  # Имитация работы API
        
        # Имитация успешной генерации
        await message.answer(f"""
╔══════════════════════════════════════════════════════════════╗
║              ✅ ГЕНЕРАЦИЯ ЗАВЕРШЕНА                          ║
╚══════════════════════════════════════════════════════════════╝

📦 Создано документов: {len(docs_to_generate)}

{chr(10).join(f"   ✅ {doc['name']}" for doc in docs_to_generate)}

📤 Отправляю файлы...
""")
        
        # TODO: Отправка файлов пользователю
        
        await message.answer("""
╔══════════════════════════════════════════════════════════════╗
║                  🎉 РАБОТА ЗАВЕРШЕНА                         ║
╚══════════════════════════════════════════════════════════════╝

Все документы успешно созданы и отправлены.

Для новой задачи используйте /start
""")
        
        await state.clear()
        
    except Exception as e:
        logger.error(f"Ошибка при генерации документов: {e}")
        await message.answer(f"""
❌ Ошибка при генерации документов:
{str(e)}

Попробуйте снова или обратитесь к администратору.
""")
        await state.clear()
