#!/usr/bin/env python3
"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¤– J.A.R.V.I.S. v3.0 - BIMAR Presale Intelligence System   â•‘
â•‘  Just A Rather Very Intelligent Sales-assistant              â•‘
â•‘                                                              â•‘
â•‘  Telegram Bot Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€ĞµÑĞµĞ¹Ğ»-Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²                 â•‘
â•‘  Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Manus API                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

import os
import sys
import json
import asyncio
import aiohttp
import logging
import tempfile
from datetime import datetime, timedelta
from typing import Optional, Dict, Any, List
from urllib.parse import urlparse

from aiogram import Bot, Dispatcher, Router, F
from aiogram.types import (
    Message, CallbackQuery, FSInputFile,
    ReplyKeyboardMarkup, KeyboardButton,
    InlineKeyboardMarkup, InlineKeyboardButton,
    ReplyKeyboardRemove
)
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.enums import ParseMode

# ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ FSM Ğ´Ğ»Ñ Ğ´Ğ²ÑƒÑ…ÑÑ‚Ğ°Ğ¿Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°
class PresaleStates(StatesGroup):
    """Ğ¤Ğ¡Ğœ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€ĞµÑĞµĞ¹Ğ»-Ğ±Ğ¾Ñ‚Ğ°"""
    waiting_for_url = State()       # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ URL ÑĞ°Ğ¹Ñ‚Ğ°
    waiting_for_goal = State()      # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ñ†ĞµĞ»Ğ¸
    analyzing = State()             # Ğ­Ñ‚Ğ°Ğ¿ 1: ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾ÑÑŒĞµ
    selecting_docs = State()        # Ğ­Ñ‚Ğ°Ğ¿ 2: Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
    generating_docs = State()       # Ğ­Ñ‚Ğ°Ğ¿ 3: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
    waiting_for_constraints = State()  # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¹
    processing = State()            # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Manus

# Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°
DOCUMENT_TYPES = {
    "dossier": {
        "id": "dossier",
        "name": "01_Ğ”Ğ¾ÑÑŒĞµ_Ğ½Ğ°_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°",
        "filename": "01_Ğ”Ğ¾ÑÑŒĞµ_Ğ½Ğ°_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°.docx",
        "format": "docx",
        "icon": "ğŸ“‹",
        "description": "ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸, Ğ±Ğ¾Ğ»Ğ¸, Ğ›ĞŸĞ ",
        "mandatory": True
    },
    "use_cases": {
        "id": "use_cases",
        "name": "02_Ğ ĞµÑˆĞµĞ½Ğ¸Ñ_BIMAR",
        "filename": "02_Ğ ĞµÑˆĞµĞ½Ğ¸Ñ_BIMAR.xlsx",
        "format": "xlsx",
        "icon": "ğŸ—ºï¸",
        "description": "ĞšĞ°Ñ€Ñ‚Ğ° Ğ¼Ğ¾Ğ´ÑƒĞ»ĞµĞ¹ BimAR Ğ¸ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸ĞµĞ²"
    },
    "roi": {
        "id": "roi",
        "name": "03_Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ°_ÑĞ´ĞµĞ»ĞºĞ¸",
        "filename": "03_Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ°_ÑĞ´ĞµĞ»ĞºĞ¸.xlsx",
        "format": "xlsx",
        "icon": "ğŸ’°",
        "description": "ROI ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ + ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¸Ğ»Ğ¾Ñ‚Ğ°"
    },
    "sow": {
        "id": "sow",
        "name": "04_ĞŸĞ¸Ğ»Ğ¾Ñ‚_Ğ¢Ğ—",
        "filename": "04_ĞŸĞ¸Ğ»Ğ¾Ñ‚_Ğ¢Ğ—.docx",
        "format": "docx",
        "icon": "ğŸ“",
        "description": "Ğ¢ĞµÑ…Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ğ¿Ğ¸Ğ»Ğ¾Ñ‚ 90 Ğ´Ğ½ĞµĞ¹"
    },
    "stakeholders": {
        "id": "stakeholders",
        "name": "05_Ğ›ĞŸĞ _Ğ¸_ĞºĞ²Ğ°Ğ»Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ",
        "filename": "05_Ğ›ĞŸĞ _Ğ¸_ĞºĞ²Ğ°Ğ»Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ.xlsx",
        "format": "xlsx",
        "icon": "ğŸ¯",
        "description": "ĞšĞ°Ñ€Ñ‚Ğ° Ğ›ĞŸĞ  + MEDDPICC"
    },
    "presentation": {
        "id": "presentation",
        "name": "06_ĞŸĞ¸Ñ‚Ñ‡_Ğ´Ğ»Ñ_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°",
        "filename": "06_ĞŸĞ¸Ñ‚Ñ‡_Ğ´Ğ»Ñ_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°.pptx",
        "format": "pptx",
        "icon": "ğŸ“Š",
        "description": "ĞŸÑ€ĞµĞ·ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ 10-12 ÑĞ»Ğ°Ğ¹Ğ´Ğ¾Ğ²"
    },
    "verification": {
        "id": "verification",
        "name": "07_Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ",
        "filename": "07_Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ.docx",
        "format": "docx",
        "icon": "âœ…",
        "description": "Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€ĞµÑĞµĞ¹Ğ»Ğ°"
    }
}

# Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ)
SELECTABLE_DOCS = [k for k, v in DOCUMENT_TYPES.items() if not v.get("mandatory", False)]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
MANUS_API_KEY = os.getenv("MANUS_API_KEY")
MANUS_PROJECT_ID = os.getenv("MANUS_PROJECT_ID", "YghG6cpo3udE8p2gcYzQfP")
MANUS_BASE_URL = os.getenv("MANUS_BASE_URL", "https://api.manus.ai")
ALLOWED_USER_IDS = os.getenv("ALLOWED_USER_IDS", "")
QUICK_MODE_DEFAULT = os.getenv("QUICK_MODE", "0") == "1"
POLLING_INTERVAL = int(os.getenv("POLLING_INTERVAL", "10"))
TASK_TIMEOUT = int(os.getenv("TASK_TIMEOUT", "1500"))

VERSION = "3.0"
START_TIME = datetime.now()

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…
if not TELEGRAM_BOT_TOKEN:
    print("âŒ ERROR: TELEGRAM_BOT_TOKEN not set")
    raise ValueError("TELEGRAM_BOT_TOKEN environment variable is required")

if not MANUS_API_KEY:
    print("âš ï¸ WARNING: MANUS_API_KEY not set - API calls will fail")

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ¥Ğ ĞĞĞ˜Ğ›Ğ˜Ğ©Ğ• Ğ”ĞĞĞĞ«Ğ¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

user_tasks: Dict[int, List[Dict]] = {}
user_settings: Dict[int, Dict] = {}
stats = {
    "requests_today": 0,
    "successful": 0,
    "errors": 0,
    "files_sent": 0
}

# ĞšÑÑˆ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ URL (Ğ´Ğ¾Ğ¼ĞµĞ½ -> Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸)
url_cache: Dict[str, Dict] = {}
CACHE_TTL_HOURS = int(os.getenv("CACHE_TTL_HOURS", "24"))  # Ğ’Ñ€ĞµĞ¼Ñ Ğ¶Ğ¸Ğ·Ğ½Ğ¸ ĞºÑÑˆĞ° Ğ² Ñ‡Ğ°ÑĞ°Ñ…

# ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
task_queue: asyncio.Queue = None  # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ
active_tasks: Dict[str, Dict] = {}  # task_id -> Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğµ
MAX_CONCURRENT_TASKS = int(os.getenv("MAX_CONCURRENT_TASKS", "3"))  # ĞœĞ°ĞºÑ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡

# Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸ (user_id -> [{task_id, domain, files, date}])
completed_tasks: Dict[int, List[Dict]] = {}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ‘ĞĞ¢Ğ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bot = Bot(token=TELEGRAM_BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)
router = Router()
dp.include_router(router)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞšĞ›ĞĞ’Ğ˜ĞĞ¢Ğ£Ğ Ğ«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def get_main_keyboard() -> ReplyKeyboardMarkup:
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="ğŸš€ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·"), KeyboardButton(text="ğŸ“Š ĞœĞ¾Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸")],
            [KeyboardButton(text="âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸"), KeyboardButton(text="ğŸ“ˆ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ")],
            [KeyboardButton(text="ğŸ“– Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ°")]
        ],
        resize_keyboard=True,
        is_persistent=True
    )

def get_goals_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ¯ Ğ’Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ/ĞºĞ²Ğ°Ğ»Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ", callback_data="goal_intro")],
            [InlineKeyboardButton(text="ğŸš€ Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¸Ğ»Ğ¾Ñ‚Ğ°", callback_data="goal_pilot")],
            [InlineKeyboardButton(text="ğŸ’¼ Ğ¢ĞšĞŸ", callback_data="goal_tkp")],
            [InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="cancel")]
        ]
    )

def get_settings_keyboard(user_id: int) -> InlineKeyboardMarkup:
    settings = get_user_settings(user_id)
    quick_mode = "âœ…" if settings.get("quick_mode", False) else "âŒ"
    notifications = "âœ…" if settings.get("notifications", True) else "âŒ"
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=f"âš¡ Quick Mode {quick_mode}", callback_data="toggle_quick_mode")],
            [InlineKeyboardButton(text=f"ğŸ”” Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ {notifications}", callback_data="toggle_notifications")],
            [InlineKeyboardButton(text="ğŸŒ Ğ¯Ğ·Ñ‹Ğº", callback_data="settings_language")],
            [InlineKeyboardButton(text="ğŸ¯ Ğ¦ĞµĞ»ÑŒ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ", callback_data="settings_default_goal")],
            [InlineKeyboardButton(text="ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="back_to_menu")]
        ]
    )

def get_language_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹", callback_data="lang_ru"),
             InlineKeyboardButton(text="ğŸ‡¬ğŸ‡§ English", callback_data="lang_en")],
            [InlineKeyboardButton(text="ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="back_to_settings")]
        ]
    )

def get_default_goal_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="â­• ĞĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ° (ÑĞ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°Ñ‚ÑŒ)", callback_data="default_goal_none")],
            [InlineKeyboardButton(text="ğŸ¯ Ğ’Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ/ĞºĞ²Ğ°Ğ»Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ", callback_data="default_goal_intro")],
            [InlineKeyboardButton(text="ğŸš€ Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¸Ğ»Ğ¾Ñ‚Ğ°", callback_data="default_goal_pilot")],
            [InlineKeyboardButton(text="ğŸ’¼ Ğ¢ĞšĞŸ", callback_data="default_goal_tkp")],
            [InlineKeyboardButton(text="ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="back_to_settings")]
        ]
    )

def get_status_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ", callback_data="refresh_status")],
            [InlineKeyboardButton(text="ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´ Ğ² Ğ¼ĞµĞ½Ñ", callback_data="back_to_menu")]
        ]
    )

def get_cancel_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[[InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="cancel")]]
    )

def get_tasks_keyboard(user_id: int) -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡"""
    tasks = get_completed_tasks(user_id)
    buttons = []
    for i, task in enumerate(tasks[:5], 1):
        domain = task.get("domain", "unknown")[:15]
        task_id = task.get("task_id", "")
        buttons.append([InlineKeyboardButton(
            text=f"#{i} ğŸ“ {domain}",
            callback_data=f"download_task_{task_id}"
        )])
    buttons.append([InlineKeyboardButton(text="ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´ Ğ² Ğ¼ĞµĞ½Ñ", callback_data="back_to_menu")])
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_cache_keyboard(domain: str) -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºÑÑˆ Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ"""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="âš¡ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹", callback_data=f"use_cache_{domain}")],
            [InlineKeyboardButton(text="ğŸ”„ Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾", callback_data="regenerate")],
            [InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="cancel")]
        ]
    )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def get_user_settings(user_id: int) -> Dict:
    if user_id not in user_settings:
        user_settings[user_id] = {
            "quick_mode": QUICK_MODE_DEFAULT,
            "notifications": True,
            "language": "ru",
            "default_goal": None
        }
    return user_settings[user_id]

def get_user_tasks(user_id: int) -> List[Dict]:
    if user_id not in user_tasks:
        user_tasks[user_id] = []
    return user_tasks[user_id]

def add_user_task(user_id: int, task: Dict):
    tasks = get_user_tasks(user_id)
    tasks.insert(0, task)
    user_tasks[user_id] = tasks[:10]

def is_user_allowed(user_id: int) -> bool:
    if not ALLOWED_USER_IDS:
        return True
    allowed = [int(x.strip()) for x in ALLOWED_USER_IDS.split(",") if x.strip()]
    return user_id in allowed if allowed else True

def validate_url(url: str) -> bool:
    try:
        result = urlparse(url)
        return all([result.scheme in ['http', 'https'], result.netloc])
    except:
        return False

def get_uptime() -> str:
    delta = datetime.now() - START_TIME
    hours, remainder = divmod(int(delta.total_seconds()), 3600)
    minutes, seconds = divmod(remainder, 60)
    return f"{hours}Ñ‡ {minutes}Ğ¼ {seconds}Ñ"

def get_progress_bar(percent: int, length: int = 10) -> str:
    filled = int(length * percent / 100)
    return "â–ˆ" * filled + "â–‘" * (length - filled)

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
def get_cached_result(domain: str) -> Optional[Dict]:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ğ¾ Ğ´Ğ¾Ğ¼ĞµĞ½Ñƒ"""
    if domain in url_cache:
        cached = url_cache[domain]
        cache_time = datetime.fromisoformat(cached.get("cached_at", "2000-01-01"))
        if datetime.now() - cache_time < timedelta(hours=CACHE_TTL_HOURS):
            logger.info(f"Cache hit for {domain}")
            return cached
        else:
            # ĞšÑÑˆ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ»
            del url_cache[domain]
            logger.info(f"Cache expired for {domain}")
    return None

def set_cached_result(domain: str, task_id: str, files: List[Dict]):
    """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ² ĞºÑÑˆ"""
    url_cache[domain] = {
        "task_id": task_id,
        "files": files,
        "cached_at": datetime.now().isoformat()
    }
    logger.info(f"Cached result for {domain}")

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼Ğ¸
def get_completed_tasks(user_id: int) -> List[Dict]:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    if user_id not in completed_tasks:
        completed_tasks[user_id] = []
    return completed_tasks[user_id]

def add_completed_task(user_id: int, task_data: Dict):
    """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸"""
    tasks = get_completed_tasks(user_id)
    tasks.insert(0, task_data)
    completed_tasks[user_id] = tasks[:20]  # Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 20 Ğ·Ğ°Ğ´Ğ°Ñ‡
    logger.info(f"Added completed task for user {user_id}: {task_data.get('domain')}")

def get_task_by_id(user_id: int, task_id: str) -> Optional[Dict]:
    """ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¿Ğ¾ ID"""
    tasks = get_completed_tasks(user_id)
    for task in tasks:
        if task.get("task_id") == task_id:
            return task
    return None

# Ğ­Ñ‚Ğ°Ğ¿Ñ‹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸
GENERATION_STAGES = [
    {"name": "ĞĞ½Ğ°Ğ»Ğ¸Ğ· ÑĞ°Ğ¹Ñ‚Ğ°", "icon": "ğŸ”", "start": 0, "end": 20},
    {"name": "Ğ¡Ğ±Ğ¾Ñ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…", "icon": "ğŸ“Š", "start": 20, "end": 45},
    {"name": "Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²", "icon": "ğŸ“„", "start": 45, "end": 85},
    {"name": "Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ", "icon": "âœ…", "start": 85, "end": 100}
]

def get_current_stage(percent: int) -> dict:
    """ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ¿ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ñƒ"""
    for stage in GENERATION_STAGES:
        if stage["start"] <= percent < stage["end"]:
            return stage
    return GENERATION_STAGES[-1]

def get_stages_visual(percent: int) -> str:
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ğ¿Ğ¾Ğ²"""
    lines = []
    for stage in GENERATION_STAGES:
        if percent >= stage["end"]:
            status = "âœ…"
        elif percent >= stage["start"]:
            status = "â³"
        else:
            status = "â¬œ"
        lines.append(f"{status} {stage['icon']} {stage['name']}")
    return "\n".join(lines)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯ JARVIS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def msg_welcome() -> str:
    return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¤– J.A.R.V.I.S. - BIMAR SYSTEM     â•‘
â•‘  Just A Rather Very Intelligent      â•‘
â•‘  Sales-assistant                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ, ÑÑÑ€.

Ğ¯ â€” Ğ²Ğ°Ñˆ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ˜Ğ˜-Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚
Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ¸ Ğ¿Ñ€ĞµÑĞµĞ¹Ğ»-Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ².

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ® Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¼ĞµĞ½Ñ Ğ½Ğ¸Ğ¶Ğµ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸.

ğŸ’¡ Ğ”Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‚Ğ° Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ
   Â«ğŸš€ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Â»

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤– JARVIS v{VERSION} | BIMAR SYSTEM
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

def msg_new_analysis() -> str:
    return """â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸš€ Ğ—ĞĞŸĞ£Ğ¡Ğš ĞŸĞ Ğ•Ğ¡Ğ•Ğ™Ğ›-ĞĞĞĞ›Ğ˜Ğ¢Ğ˜ĞšĞ˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ URL ÑĞ°Ğ¹Ñ‚Ğ° Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸.

ğŸ“ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: https://company.com

ğŸ’¡ JARVIS Ğ¿Ñ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ¸
   Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ğ°ĞºĞµÑ‚ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²

â±ï¸ Ğ’Ñ€ĞµĞ¼Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸: 15-30 Ğ¼Ğ¸Ğ½ÑƒÑ‚"""

def msg_url_accepted(domain: str) -> str:
    return f"""â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… URL ĞŸĞ Ğ˜ĞĞ¯Ğ¢                      â”‚
â”‚  {domain[:35]:<35} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»ÑŒ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸:"""

def msg_goal_accepted(goal: str) -> str:
    return f"""â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… Ğ¦Ğ•Ğ›Ğ¬ Ğ£Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ•ĞĞ                â”‚
â”‚  {goal[:35]:<35} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”’ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:
   (on-prem, Ğ˜Ğ‘, ĞºĞ°Ğ¼ĞµÑ€Ğ°, Ğ±ĞµĞ· Ğ¾Ğ±Ğ»Ğ°ĞºĞ° Ğ¸ Ñ‚.Ğ´.)

Ğ˜Ğ»Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Â«-Â» ĞµÑĞ»Ğ¸ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¹ Ğ½ĞµÑ‚."""

def msg_processing_start() -> str:
    return """â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸš€ Ğ—ĞĞŸĞ£Ğ¡Ğš ĞĞĞĞ›Ğ˜Ğ—Ğ                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯            â”‚
â”‚ â±ï¸ Ğ’Ñ€ĞµĞ¼Ñ: 00:00                     â”‚
â”‚ ğŸ”§ Ğ­Ñ‚Ğ°Ğ¿: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â³ ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Manus AI..."""

def msg_processing_progress(elapsed_min: int, elapsed_sec: int, stage: str, percent: int) -> str:
    progress = get_progress_bar(percent)
    return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âš™ï¸ ĞĞĞĞ›Ğ˜Ğ— Ğ’ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ¡Ğ•               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â±ï¸ Ğ’Ñ€ĞµĞ¼Ñ: {elapsed_min:02d}:{elapsed_sec:02d}                       â”‚
â”‚ ğŸ“Š ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ: [{progress}] {percent}%       â”‚
â”‚ ğŸ”§ Ğ­Ñ‚Ğ°Ğ¿: {stage[:25]:<25} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ...
   JARVIS Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ."""

def msg_processing_complete(elapsed: str, files_count: int) -> str:
    return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âœ… ĞœĞ˜Ğ¡Ğ¡Ğ˜Ğ¯ Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ                  â”‚
â”‚ ğŸ“ Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²: {files_count}                        â”‚
â”‚ â±ï¸ Ğ’Ñ€ĞµĞ¼Ñ: {elapsed:<24} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“¦ Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ²Ñ‹ÑˆĞµ â¬†ï¸

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ĞœĞ¸ÑÑĞ¸Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°, ÑÑÑ€.
Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¼ĞµĞ½Ñ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° ğŸ‘‡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

def msg_help() -> str:
    return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“– Ğ¡ĞŸĞ ĞĞ’ĞšĞ JARVIS                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¤– Ğ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ•
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
JARVIS (Just A Rather Very Intelligent
Sales-assistant) â€” Ğ²Ğ°Ñˆ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹
Ğ˜Ğ˜-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ¸ Ğ¿Ñ€ĞµÑĞµĞ¹Ğ»Ğ¾Ğ².

ğŸ® Ğ“Ğ›ĞĞ’ĞĞĞ• ĞœĞ•ĞĞ®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš€ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· â†’ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€ĞµÑĞµĞ¹Ğ»Ğ°
ğŸ“Š ĞœĞ¾Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸   â†’ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸    â†’ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ±Ğ¾Ñ‚Ğ°
ğŸ“ˆ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ       â†’ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
ğŸ“– Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ°      â†’ Ğ­Ñ‚Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°

ğŸ“‹ ĞšĞĞš Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ¬
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1ï¸âƒ£ ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«ğŸš€ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Â»
2ï¸âƒ£ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ URL ÑĞ°Ğ¹Ñ‚Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
3ï¸âƒ£ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»ÑŒ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸
4ï¸âƒ£ Ğ”Ğ¾Ğ¶Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (15-30 Ğ¼Ğ¸Ğ½)
5ï¸âƒ£ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ 7 Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ ĞŸĞ Ğ•Ğ¡Ğ•Ğ™Ğ›-ĞŸĞĞšĞ•Ğ¢ (7 Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ 01_Ğ”Ğ¾ÑÑŒĞµ_Ğ½Ğ°_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°.pdf
   ĞšĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑĞ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸:
   Ğ¾Ñ‚Ñ€Ğ°ÑĞ»ÑŒ, Ğ±Ğ¾Ğ»Ğ¸, Ğ›ĞŸĞ , Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ…Ğ¾Ğ´Ğ°

ğŸ—ºï¸ 02_Ğ ĞµÑˆĞµĞ½Ğ¸Ñ_BIMAR.xlsx
   ĞšĞ°Ñ€Ñ‚Ğ° use cases BIMAR Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
   Ñ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸ Ğ¾Ñ†ĞµĞ½ĞºĞ¾Ğ¹

ğŸ’° 03_Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ°_ÑĞ´ĞµĞ»ĞºĞ¸.xlsx
   ROI-ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€: ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ,
   Ğ¾ĞºÑƒĞ¿Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ, Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚

ğŸ“ 04_ĞŸĞ¸Ğ»Ğ¾Ñ‚_Ğ¢Ğ—.docx
   Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğµ Ğ¢Ğ—: Ñ†ĞµĞ»Ğ¸, scope, KPI,
   ÑÑ‚Ğ°Ğ¿Ñ‹, ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°, Ñ€Ğ¸ÑĞºĞ¸

ğŸ¯ 05_Ğ›Ğ¸Ñ†Ğ°_Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ÑÑ‰Ğ¸Ğµ_Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ.xlsx
   Stakeholder map: Ğ›ĞŸĞ , Ğ›Ğ’Ğ ,
   Ğ²Ğ»Ğ¸ÑĞ½Ğ¸Ğµ, ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹

ğŸ“Š 06_ĞŸĞ¸Ñ‚Ñ‡_Ğ´Ğ»Ñ_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°.pptx
   ĞŸÑ€ĞµĞ·ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸:
   Ğ±Ğ¾Ğ»Ğ¸ â†’ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ â†’ ROI â†’ Ğ¿Ğ¸Ğ»Ğ¾Ñ‚

ğŸ“š 07_Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ.md
   Ğ’ÑĞµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸
   Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ Ğ¡ĞĞ’Ğ•Ğ¢Ğ«
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ ÑĞ°Ğ¹Ñ‚ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
â€¢ Ğ§ĞµĞ¼ Ñ‚Ğ¾Ñ‡Ğ½ĞµĞµ URL, Ñ‚ĞµĞ¼ Ğ»ÑƒÑ‡ÑˆĞµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·
â€¢ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ROI
â€¢ Quick Mode ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‚ Ğ²Ñ€ĞµĞ¼Ñ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤– JARVIS v{VERSION} | BIMAR SYSTEM
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

def msg_status(user_id: int) -> str:
    settings = get_user_settings(user_id)
    uptime = get_uptime()
    quick_mode = "âœ… Ğ’ĞšĞ›" if settings.get("quick_mode") else "âŒ Ğ’Ğ«ĞšĞ›"
    notifications = "âœ… Ğ’ĞšĞ›" if settings.get("notifications", True) else "âŒ Ğ’Ğ«ĞšĞ›"
    now = datetime.now().strftime("%d.%m.%Y %H:%M:%S")
    
    return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“ˆ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ« JARVIS           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ• Ğ’Ñ€ĞµĞ¼Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°: {now}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¤– Ğ¯Ğ”Ğ Ğ JARVIS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:      ğŸŸ¢ ĞĞĞ›ĞĞ™Ğ              â”‚
â”‚ Ğ’ĞµÑ€ÑĞ¸Ñ:      v{VERSION}                   â”‚
â”‚ ĞĞ¿Ñ‚Ğ°Ğ¹Ğ¼:      {uptime:<20} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”Œ MANUS API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:      ğŸŸ¢ ĞŸĞĞ”ĞšĞ›Ğ®Ğ§Ğ•ĞĞ          â”‚
â”‚ Endpoint:    api.manus.ai           â”‚
â”‚ Project ID:  {MANUS_PROJECT_ID[:20]:<20} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“¡ TELEGRAM API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:      ğŸŸ¢ ĞĞšĞ¢Ğ˜Ğ’Ğ•Ğ             â”‚
â”‚ Username:    @bimar_presale_bot     â”‚
â”‚ Polling:     âœ… Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¥ Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ:     {stats['requests_today']:<10} â”‚
â”‚ âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ñ… Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²:    {stats['successful']:<10} â”‚
â”‚ âŒ ĞÑˆĞ¸Ğ±Ğ¾Ğº:               {stats['errors']:<10} â”‚
â”‚ ğŸ“ Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾:    {stats['files_sent']:<10} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš™ï¸ Ğ’ĞĞ¨Ğ ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš¡ Quick Mode:      {quick_mode:<15} â”‚
â”‚ ğŸ”” Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ:    {notifications:<15} â”‚
â”‚ ğŸŒ Ğ¯Ğ·Ñ‹Ğº:           ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¢ Ğ’ÑĞµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ ÑˆÑ‚Ğ°Ñ‚Ğ½Ğ¾     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤– JARVIS v{VERSION} | BIMAR SYSTEM
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

def msg_my_tasks(user_id: int) -> str:
    tasks = get_completed_tasks(user_id)
    
    if not tasks:
        return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“Š ĞœĞĞ˜ Ğ—ĞĞ”ĞĞ§Ğ˜                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚
â”‚         ğŸ“­ Ğ˜Ğ¡Ğ¢ĞĞ Ğ˜Ğ¯ ĞŸĞ£Ğ¡Ğ¢Ğ            â”‚
â”‚                                     â”‚
â”‚   Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ñ…        â”‚
â”‚   Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ².                         â”‚
â”‚                                     â”‚
â”‚   ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«ğŸš€ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Â»         â”‚
â”‚   Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ñ JARVIS      â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ ĞŸĞĞ”Ğ¡ĞšĞĞ—ĞšĞ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Ğ”Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:
1. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«ğŸš€ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Â»
2. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ URL ÑĞ°Ğ¹Ñ‚Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
3. Ğ¡Ğ»ĞµĞ´ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸ÑĞ¼ JARVIS

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤– JARVIS v{VERSION} | BIMAR SYSTEM
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""
    
    task_lines = []
    for i, task in enumerate(tasks[:5], 1):
        domain = task.get("domain", "unknown")[:20]
        goal = task.get("goal", "")[:15]
        date = task.get("date", "")
        files_count = len(task.get("files", []))
        task_lines.append(f"""â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ #{i} âœ… Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¢ {domain:<32} â”‚
â”‚ ğŸ¯ {goal:<32} â”‚
â”‚ ğŸ“… {date:<32} â”‚
â”‚ ğŸ“ Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²: {files_count:<20} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜""")
    
    tasks_text = "\n\n".join(task_lines)
    
    return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“Š ĞœĞĞ˜ Ğ—ĞĞ”ĞĞ§Ğ˜                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ—‚ï¸ Ğ—Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ñ‹ (Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 5):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{tasks_text}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
   Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤– JARVIS v{VERSION} | BIMAR SYSTEM
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

def msg_settings(user_id: int) -> str:
    settings = get_user_settings(user_id)
    quick_mode = "âœ… Ğ’ĞšĞ›" if settings.get("quick_mode") else "âŒ Ğ’Ğ«ĞšĞ›"
    notifications = "âœ… Ğ’ĞšĞ›" if settings.get("notifications", True) else "âŒ Ğ’Ğ«ĞšĞ›"
    default_goal = settings.get("default_goal") or "ĞĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ°"
    
    return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âš™ï¸ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ JARVIS                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹.
Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš¡ QUICK MODE                       â”‚
â”‚ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ: {quick_mode:<18} â”‚
â”‚                                     â”‚
â”‚ ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞº Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¾ Ñ†ĞµĞ»Ğ¸ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸     â”‚
â”‚ Ğ¸ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸ÑÑ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”” Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ¯                      â”‚
â”‚ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ: {notifications:<18} â”‚
â”‚                                     â”‚
â”‚ ĞĞ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ñ Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡          â”‚
â”‚ Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ Ğ¯Ğ—Ğ«Ğš Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡Ğ                  â”‚
â”‚ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹: ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ Ğ¦Ğ•Ğ›Ğ¬ ĞŸĞ Ğ£ĞœĞĞ›Ğ§ĞĞĞ˜Ğ®                â”‚
â”‚ Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ: {default_goal:<26} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤– JARVIS v{VERSION} | BIMAR SYSTEM
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ³Ğ¸Ğ±Ñ€Ğ¸Ğ´Ğ½Ğ¾Ğ¹ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸
DOCUMENT_INFO = {
    "01_Ğ”Ğ¾ÑÑŒĞµ_Ğ½Ğ°_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°": {
        "icon": "ğŸ“‹",
        "title": "Ğ”Ğ¾ÑÑŒĞµ Ğ½Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°",
        "hint": "ğŸ’¡ Ğ˜Ğ·ÑƒÑ‡Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€ĞµĞ´ Ğ²ÑÑ‚Ñ€ĞµÑ‡ĞµĞ¹",
        "metrics": ["ğŸ¢ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸", "ğŸ¯ Ğ¢Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ…Ğ¾Ğ´Ğ°", "ğŸ‘¤ Ğ›ĞŸĞ  Ğ²Ñ‹ÑĞ²Ğ»ĞµĞ½Ñ‹", "âš ï¸ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ±Ğ¾Ğ»Ğ¸"]
    },
    "02_Ğ ĞµÑˆĞµĞ½Ğ¸Ñ_BIMAR": {
        "icon": "ğŸ—ºï¸",
        "title": "Ğ ĞµÑˆĞµĞ½Ğ¸Ñ BIMAR",
        "hint": "ğŸ’¡ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ½Ğ° Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğµ",
        "metrics": ["ğŸ“Š Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ", "â­ ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ½Ñ‹Ğµ", "ğŸš€ Quick wins"]
    },
    "03_Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ°_ÑĞ´ĞµĞ»ĞºĞ¸": {
        "icon": "ğŸ’°",
        "title": "Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ° ÑĞ´ĞµĞ»ĞºĞ¸",
        "hint": "ğŸ’¡ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ†Ğ¸Ñ„Ñ€Ñ‹ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ³Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ğ²",
        "metrics": ["ğŸ’µ Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ", "â±ï¸ ĞĞºÑƒĞ¿Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ", "ğŸ“ˆ ROI"]
    },
    "04_ĞŸĞ¸Ğ»Ğ¾Ñ‚_Ğ¢Ğ—": {
        "icon": "ğŸ“",
        "title": "ĞŸĞ¸Ğ»Ğ¾Ñ‚ Ğ¢Ğ—",
        "hint": "ğŸ’¡ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ",
        "metrics": ["ğŸ¯ Ğ¦ĞµĞ»Ğ¸ Ğ¿Ğ¸Ğ»Ğ¾Ñ‚Ğ°", "ğŸ“… Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ", "âœ… KPI"]
    },
    "05_Ğ›Ğ¸Ñ†Ğ°_Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ÑÑ‰Ğ¸Ğµ_Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ": {
        "icon": "ğŸ¯",
        "title": "Ğ›Ğ¸Ñ†Ğ° Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ÑÑ‰Ğ¸Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ",
        "hint": "ğŸ’¡ Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸",
        "metrics": ["ğŸ‘¤ Ğ¡Ñ‚ĞµĞ¹ĞºÑ…Ğ¾Ğ»Ğ´ĞµÑ€Ñ‹", "âœ… Ğ›ĞŸĞ ", "âš ï¸ Ğ‘Ğ»Ğ¾ĞºĞµÑ€Ñ‹"]
    },
    "06_ĞŸĞ¸Ñ‚Ñ‡_Ğ´Ğ»Ñ_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°": {
        "icon": "ğŸ“Š",
        "title": "ĞŸĞ¸Ñ‚Ñ‡ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°",
        "hint": "ğŸ’¡ ĞŸÑ€ĞµĞ·ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸",
        "metrics": ["ğŸ“‘ Ğ¡Ğ»Ğ°Ğ¹Ğ´Ğ¾Ğ²: 10", "â±ï¸ Ğ’Ñ€ĞµĞ¼Ñ: ~10 Ğ¼Ğ¸Ğ½", "ğŸ¯ Ğ­ĞºÑĞ¿Ñ€ĞµÑÑ-Ğ¿Ğ¸Ñ‚Ñ‡"]
    },
    "07_Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ": {
        "icon": "ğŸ“š",
        "title": "Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ",
        "hint": "ğŸ’¡ Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…",
        "metrics": ["ğŸ”— Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸", "ğŸ“… Ğ”Ğ°Ñ‚Ğ° ÑĞ±Ğ¾Ñ€Ğ°", "âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ¾"]
    }
}

def get_document_key(filename: str) -> str:
    """Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ ĞºĞ»ÑÑ‡ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° Ğ¸Ğ· Ğ¸Ğ¼ĞµĞ½Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ°"""
    for key in DOCUMENT_INFO.keys():
        if key in filename:
            return key
    return None

def msg_file_caption(filename: str) -> str:
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ² ÑÑ‚Ğ¸Ğ»Ğµ JARVIS"""
    key = get_document_key(filename)
    if not key:
        return f"ğŸ“ {filename}"
    
    info = DOCUMENT_INFO[key]
    metrics_text = "\n".join([f"â”‚ {m:<33} â”‚" for m in info["metrics"]])
    
    return f"""{info['icon']} {info['title']}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
{metrics_text}
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

{info['hint']}"""

def msg_delivery_summary(domain: str, files_count: int, elapsed: str) -> str:
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾Ğµ ÑĞ°Ğ¼Ğ¼Ğ°Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ´ Ğ²Ñ‹Ğ´Ğ°Ñ‡ĞµĞ¹ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"""
    return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“¦ ĞŸĞ Ğ•Ğ¡Ğ•Ğ™Ğ›-ĞŸĞĞšĞ•Ğ¢ Ğ“ĞĞ¢ĞĞ’             â•‘
â•‘  {domain[:35]:<35} â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ¡ÑÑ€, Ğ¼Ğ¸ÑÑĞ¸Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°.
Ğ”Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑÑ {files_count} Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²...

â”Œâ”€ ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ• ĞœĞ•Ğ¢Ğ Ğ˜ĞšĞ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚
â”‚  ğŸ“ Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²:    {files_count:<16} â”‚
â”‚  â±ï¸ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ:     {elapsed:<16} â”‚
â”‚  ğŸ¯ ĞšĞ»Ğ¸ĞµĞ½Ñ‚:        ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½  â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

def msg_delivery_complete(domain: str, files_count: int, elapsed: str) -> str:
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ Ğ²ÑĞµÑ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²"""
    return f"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âœ… Ğ”ĞĞ¡Ğ¢ĞĞ’ĞšĞ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²: {files_count:<20} â”‚
â”‚ â±ï¸ Ğ’Ñ€ĞµĞ¼Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸: {elapsed:<14} â”‚
â”‚ ğŸ¯ ĞšĞ»Ğ¸ĞµĞ½Ñ‚: {domain[:24]:<24} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Ğ£Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğµ, ÑÑÑ€.
ğŸ¤– JARVIS v{VERSION} | BIMAR SYSTEM
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

def msg_error(error_text: str) -> str:
    return f"""â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {error_text[:35]:<35} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ° Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ
Ğ² Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºÑƒÑ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ BIMAR.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

def msg_access_denied() -> str:
    return """â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ”’ Ğ”ĞĞ¡Ğ¢Ğ£ĞŸ Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•Ğ                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑÑ‚Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ.   â”‚
â”‚                                     â”‚
â”‚ ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ BIMAR   â”‚
â”‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°.              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANUS API
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def create_manus_task(url: str, goal: str, constraints: str) -> Optional[str]:
    prompt = f"""ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ URL: {url}

Ğ¦ĞµĞ»ÑŒ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸: {goal}
ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°: {constraints}

Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ñ€ĞµÑĞµĞ¹Ğ»-Ğ¿Ğ°ĞºĞµÑ‚:
1. 01_Ğ”Ğ¾ÑÑŒĞµ_Ğ½Ğ°_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°.pdf - ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑĞ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸: Ğ¾Ñ‚Ñ€Ğ°ÑĞ»ÑŒ, Ğ±Ğ¾Ğ»Ğ¸, Ğ›ĞŸĞ , Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ…Ğ¾Ğ´Ğ°, Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»
2. 02_Ğ ĞµÑˆĞµĞ½Ğ¸Ñ_BIMAR.xlsx - ĞºĞ°Ñ€Ñ‚Ğ° ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸ĞµĞ² Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ BIMAR Ñ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸ Ğ¾Ñ†ĞµĞ½ĞºĞ¾Ğ¹ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸
3. 03_Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ°_ÑĞ´ĞµĞ»ĞºĞ¸.xlsx - ROI-ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€: ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ, Ğ¾ĞºÑƒĞ¿Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ, Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚
4. 04_ĞŸĞ¸Ğ»Ğ¾Ñ‚_Ğ¢Ğ—.docx - Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ğ¿Ğ¸Ğ»Ğ¾Ñ‚: Ñ†ĞµĞ»Ğ¸, scope, KPI, ÑÑ‚Ğ°Ğ¿Ñ‹, Ñ€Ğ¸ÑĞºĞ¸
5. 05_Ğ›Ğ¸Ñ†Ğ°_Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ÑÑ‰Ğ¸Ğµ_Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ.xlsx - stakeholder map: Ğ›ĞŸĞ , Ğ›Ğ’Ğ , Ğ²Ğ»Ğ¸ÑĞ½Ğ¸Ğµ, ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹
6. 06_ĞŸĞ¸Ñ‚Ñ‡_Ğ´Ğ»Ñ_ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°.pptx - Ğ¿Ñ€ĞµĞ·ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸: Ğ±Ğ¾Ğ»Ğ¸ â†’ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ â†’ ROI â†’ Ğ¿Ğ¸Ğ»Ğ¾Ñ‚
7. 07_Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ.md - ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ² Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""

    headers = {
        "API_KEY": MANUS_API_KEY,
        "Content-Type": "application/json"
    }
    payload = {"prompt": prompt, "projectId": MANUS_PROJECT_ID}
    
    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(
                f"{MANUS_BASE_URL}/v1/tasks",
                headers=headers,
                json=payload,
                timeout=aiohttp.ClientTimeout(total=60)
            ) as response:
                data = await response.json()
                logger.info(f"Task created response: {data}")
                return data.get("task_id")
    except Exception as e:
        logger.error(f"Error creating task: {e}")
        return None

async def get_task_status(task_id: str) -> Dict[str, Any]:
    headers = {"API_KEY": MANUS_API_KEY}
    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(
                f"{MANUS_BASE_URL}/v1/tasks/{task_id}",
                headers=headers,
                timeout=aiohttp.ClientTimeout(total=30)
            ) as response:
                return await response.json()
    except Exception as e:
        logger.error(f"Error getting task status: {e}")
        return {"status": "error", "error": str(e)}

async def download_file(url: str, filename: str) -> Optional[str]:
    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(url, timeout=aiohttp.ClientTimeout(total=120)) as response:
                if response.status == 200:
                    temp_dir = tempfile.mkdtemp()
                    filepath = os.path.join(temp_dir, filename)
                    with open(filepath, 'wb') as f:
                        f.write(await response.read())
                    return filepath
    except Exception as e:
        logger.error(f"Error downloading file: {e}")
    return None

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ ĞšĞĞœĞĞĞ”
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    if not is_user_allowed(message.from_user.id):
        await message.answer(msg_access_denied())
        return
    await state.clear()
    await message.answer(msg_welcome(), reply_markup=get_main_keyboard())

@router.message(Command("help"))
async def cmd_help(message: Message):
    if not is_user_allowed(message.from_user.id):
        return
    await message.answer(msg_help(), reply_markup=get_main_keyboard())

@router.message(Command("status"))
async def cmd_status(message: Message):
    if not is_user_allowed(message.from_user.id):
        return
    await message.answer(msg_status(message.from_user.id), reply_markup=get_status_keyboard())

@router.message(Command("cancel"))
async def cmd_cancel(message: Message, state: FSMContext):
    await state.clear()
    await message.answer("âŒ ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°.\n\nĞ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¼ĞµĞ½Ñ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸.", reply_markup=get_main_keyboard())

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ ĞšĞĞĞŸĞĞš ĞœĞ•ĞĞ®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(F.text == "ğŸš€ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·")
async def btn_new_analysis(message: Message, state: FSMContext):
    if not is_user_allowed(message.from_user.id):
        return
    stats["requests_today"] += 1
    await state.set_state(PresaleStates.waiting_for_url)
    await message.answer(msg_new_analysis(), reply_markup=get_cancel_keyboard())

@router.message(F.text == "ğŸ“Š ĞœĞ¾Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸")
async def btn_my_tasks(message: Message):
    if not is_user_allowed(message.from_user.id):
        return
    user_id = message.from_user.id
    tasks = get_completed_tasks(user_id)
    if tasks:
        await message.answer(msg_my_tasks(user_id), reply_markup=get_tasks_keyboard(user_id))
    else:
        await message.answer(msg_my_tasks(user_id), reply_markup=get_main_keyboard())

@router.message(F.text == "âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸")
async def btn_settings(message: Message):
    if not is_user_allowed(message.from_user.id):
        return
    await message.answer(msg_settings(message.from_user.id), reply_markup=get_settings_keyboard(message.from_user.id))

@router.message(F.text == "ğŸ“ˆ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ")
async def btn_status(message: Message):
    if not is_user_allowed(message.from_user.id):
        return
    await message.answer(msg_status(message.from_user.id), reply_markup=get_status_keyboard())

@router.message(F.text == "ğŸ“– Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ°")
async def btn_help(message: Message):
    if not is_user_allowed(message.from_user.id):
        return
    await message.answer(msg_help(), reply_markup=get_main_keyboard())

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ CALLBACK
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.callback_query(F.data == "cancel")
async def callback_cancel(callback: CallbackQuery, state: FSMContext):
    await state.clear()
    await callback.message.edit_text("âŒ ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°.")
    await callback.message.answer("Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¼ĞµĞ½Ñ Ğ´Ğ»Ñ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸.", reply_markup=get_main_keyboard())
    await callback.answer()

@router.callback_query(F.data == "back_to_menu")
async def callback_back_to_menu(callback: CallbackQuery):
    await callback.message.edit_text("ğŸ  Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ")
    await callback.message.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:", reply_markup=get_main_keyboard())
    await callback.answer()

@router.callback_query(F.data == "back_to_settings")
async def callback_back_to_settings(callback: CallbackQuery):
    await callback.message.edit_text(msg_settings(callback.from_user.id), reply_markup=get_settings_keyboard(callback.from_user.id))
    await callback.answer()

@router.callback_query(F.data == "toggle_quick_mode")
async def callback_toggle_quick_mode(callback: CallbackQuery):
    settings = get_user_settings(callback.from_user.id)
    settings["quick_mode"] = not settings.get("quick_mode", False)
    status = "Ğ²ĞºĞ»ÑÑ‡ĞµĞ½" if settings["quick_mode"] else "Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½"
    await callback.message.edit_text(msg_settings(callback.from_user.id), reply_markup=get_settings_keyboard(callback.from_user.id))
    await callback.answer(f"âš¡ Quick Mode {status}")

@router.callback_query(F.data == "toggle_notifications")
async def callback_toggle_notifications(callback: CallbackQuery):
    settings = get_user_settings(callback.from_user.id)
    settings["notifications"] = not settings.get("notifications", True)
    status = "Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹" if settings["notifications"] else "Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹"
    await callback.message.edit_text(msg_settings(callback.from_user.id), reply_markup=get_settings_keyboard(callback.from_user.id))
    await callback.answer(f"ğŸ”” Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ {status}")

@router.callback_query(F.data == "settings_language")
async def callback_settings_language(callback: CallbackQuery):
    await callback.message.edit_text(
        """â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸŒ Ğ¯Ğ—Ğ«Ğš Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡Ğ                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ JARVIS:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹        â† Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜Ğ™       â”‚
â”‚ ğŸ‡¬ğŸ‡§ English                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ Ğ¯Ğ·Ñ‹Ğº Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ°:
â€¢ Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ±Ğ¾Ñ‚Ğ°
â€¢ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹
â€¢ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ""",
        reply_markup=get_language_keyboard()
    )
    await callback.answer()

@router.callback_query(F.data == "settings_default_goal")
async def callback_settings_default_goal(callback: CallbackQuery):
    await callback.message.edit_text(
        """â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¯ Ğ¦Ğ•Ğ›Ğ¬ ĞŸĞ Ğ£ĞœĞĞ›Ğ§ĞĞĞ˜Ğ®               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ†ĞµĞ»ÑŒ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ±ÑƒĞ´ĞµÑ‚
Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒÑÑ Ğº
Ğ½Ğ¾Ğ²Ñ‹Ğ¼ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ğ¼:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â­• ĞĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ° (ÑĞ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°Ñ‚ÑŒ)           â”‚
â”‚ ğŸ¯ Ğ’Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ/ĞºĞ²Ğ°Ğ»Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ             â”‚
â”‚ ğŸš€ Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¸Ğ»Ğ¾Ñ‚Ğ°              â”‚
â”‚ ğŸ’¼ Ğ¢ĞšĞŸ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜""",
        reply_markup=get_default_goal_keyboard()
    )
    await callback.answer()

@router.callback_query(F.data.startswith("default_goal_"))
async def callback_set_default_goal(callback: CallbackQuery):
    goal_map = {
        "default_goal_none": None,
        "default_goal_intro": "Ğ’Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ/ĞºĞ²Ğ°Ğ»Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ",
        "default_goal_pilot": "Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¸Ğ»Ğ¾Ñ‚Ğ°",
        "default_goal_tkp": "Ğ¢ĞšĞŸ"
    }
    settings = get_user_settings(callback.from_user.id)
    settings["default_goal"] = goal_map.get(callback.data)
    await callback.message.edit_text(msg_settings(callback.from_user.id), reply_markup=get_settings_keyboard(callback.from_user.id))
    await callback.answer("âœ… Ğ¦ĞµĞ»ÑŒ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°")

@router.callback_query(F.data.startswith("lang_"))
async def callback_set_language(callback: CallbackQuery):
    settings = get_user_settings(callback.from_user.id)
    settings["language"] = callback.data.replace("lang_", "")
    await callback.message.edit_text(msg_settings(callback.from_user.id), reply_markup=get_settings_keyboard(callback.from_user.id))
    await callback.answer("âœ… Ğ¯Ğ·Ñ‹Ğº ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½")

@router.callback_query(F.data == "refresh_status")
async def callback_refresh_status(callback: CallbackQuery):
    await callback.message.edit_text(
        """â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“ˆ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ« JARVIS           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚
â”‚      ğŸ”„ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ”ĞĞĞĞ«Ğ¥...        â”‚
â”‚                                     â”‚
â”‚      Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼...         â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"""
    )
    await asyncio.sleep(1)
    await callback.message.edit_text(msg_status(callback.from_user.id), reply_markup=get_status_keyboard())
    await callback.answer("âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")

@router.callback_query(F.data.startswith("goal_"))
async def callback_select_goal(callback: CallbackQuery, state: FSMContext):
    goal_map = {
        "goal_intro": "Ğ’Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ/ĞºĞ²Ğ°Ğ»Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ",
        "goal_pilot": "Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¸Ğ»Ğ¾Ñ‚Ğ°",
        "goal_tkp": "Ğ¢ĞšĞŸ"
    }
    goal = goal_map.get(callback.data, "Ğ¢ĞšĞŸ")
    await state.update_data(goal=goal)
    await callback.message.edit_text("âœ… Ğ¦ĞµĞ»ÑŒ: " + goal)
    await callback.answer()
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€ĞµÑĞµĞ¹Ğ»-Ğ¿Ğ°ĞºĞµÑ‚Ğ°
    await process_presale(callback.message, state, callback.from_user.id)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ™
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(StateFilter(PresaleStates.waiting_for_url))
async def handle_url(message: Message, state: FSMContext):
    url = message.text.strip()
    if not url.startswith(('http://', 'https://')):
        url = 'https://' + url
    
    if not validate_url(url):
        await message.answer(msg_error("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ URL"), reply_markup=get_cancel_keyboard())
        return
    
    domain = urlparse(url).netloc
    await state.update_data(url=url, domain=domain)
    settings = get_user_settings(message.from_user.id)
    
    if settings.get("quick_mode") and settings.get("default_goal"):
        await state.update_data(goal=settings["default_goal"], constraints="-")
        await message.answer(f"âœ… URL: {domain}\nâœ… Ğ¦ĞµĞ»ÑŒ: {settings['default_goal']}")
        await process_presale(message, state, message.from_user.id)
    else:
        await state.set_state(PresaleStates.waiting_for_goal)
        await message.answer(msg_url_accepted(domain), reply_markup=get_goals_keyboard())

@router.message(StateFilter(PresaleStates.waiting_for_constraints))
async def handle_constraints(message: Message, state: FSMContext):
    constraints = message.text.strip()
    await state.update_data(constraints=constraints)
    await process_presale(message, state, message.from_user.id)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ¡ĞĞĞ’ĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ ĞŸĞ Ğ•Ğ¡Ğ•Ğ™Ğ›Ğ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def process_presale(message: Message, state: FSMContext, user_id: int):
    data = await state.get_data()
    url = data.get("url")
    domain = data.get("domain")
    goal = data.get("goal")
    constraints = data.get("constraints", "-")
    
    await state.set_state(PresaleStates.processing)
    status_msg = await message.answer(msg_processing_start())
    start_time = datetime.now()
    
    task_id = await create_manus_task(url, goal, constraints)
    
    if not task_id:
        stats["errors"] += 1
        add_user_task(user_id, {"domain": domain, "goal": goal, "status": "error", "date": datetime.now().strftime("%d.%m.%Y %H:%M")})
        await status_msg.edit_text(msg_error("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ² Manus"))
        await state.clear()
        await message.answer("Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¼ĞµĞ½Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸.", reply_markup=get_main_keyboard())
        return
    
    task_info = {"task_id": task_id, "domain": domain, "goal": goal, "status": "running", "date": datetime.now().strftime("%d.%m.%Y %H:%M")}
    add_user_task(user_id, task_info)
    
    iteration = 0
    stages = ["ĞĞ½Ğ°Ğ»Ğ¸Ğ· ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸", "Ğ¡Ğ±Ğ¾Ñ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…", "Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²", "Ğ¤Ğ¸Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ"]
    
    while True:
        elapsed = datetime.now() - start_time
        elapsed_sec = int(elapsed.total_seconds())
        elapsed_min = elapsed_sec // 60
        elapsed_sec_display = elapsed_sec % 60
        
        if elapsed_sec > TASK_TIMEOUT:
            stats["errors"] += 1
            task_info["status"] = "error"
            await status_msg.edit_text(msg_error("ĞŸÑ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ"))
            await state.clear()
            await message.answer("Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¼ĞµĞ½Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸.", reply_markup=get_main_keyboard())
            return
        
        task_status = await get_task_status(task_id)
        status = task_status.get("status", "running")
        
        if status == "completed":
            break
        elif status == "failed":
            stats["errors"] += 1
            task_info["status"] = "error"
            await status_msg.edit_text(msg_error("Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ°ÑÑŒ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹"))
            await state.clear()
            await message.answer("Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¼ĞµĞ½Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸.", reply_markup=get_main_keyboard())
            return
        
        iteration += 1
        stage_idx = min(iteration // 10, len(stages) - 1)
        percent = min(iteration * 3, 95)
        
        try:
            await status_msg.edit_text(msg_processing_progress(elapsed_min, elapsed_sec_display, stages[stage_idx], percent))
        except:
            pass
        
        await asyncio.sleep(POLLING_INTERVAL)
    
    task_info["status"] = "completed"
    stats["successful"] += 1
    
    # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸Ğ· output[].content[] Ñ type=output_file
    artifacts = []
    for output_item in task_status.get("output", []):
        content = output_item.get("content", [])
        if isinstance(content, list):
            for item in content:
                if item.get("type") == "output_file" and item.get("fileUrl"):
                    artifacts.append({
                        "url": item.get("fileUrl"),
                        "name": item.get("fileName", "file")
                    })
    
    logger.info(f"Found {len(artifacts)} files to send")
    files_sent = 0
    
    # Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
    elapsed = datetime.now() - start_time
    elapsed_str = f"{int(elapsed.total_seconds()) // 60:02d}:{int(elapsed.total_seconds()) % 60:02d}"
    
    # Ğ“Ğ˜Ğ‘Ğ Ğ˜Ğ”ĞĞĞ¯ Ğ’Ğ«Ğ”ĞĞ§Ğ: Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾Ğµ ÑĞ°Ğ¼Ğ¼Ğ°Ñ€Ğ¸
    await status_msg.edit_text(msg_delivery_summary(domain, len(artifacts), elapsed_str))
    
    # Ğ—Ğ°Ñ‚ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸ÑĞ¼Ğ¸
    for artifact in artifacts:
        file_url = artifact.get("url")
        file_name = artifact.get("name", "file")
        
        if file_url:
            filepath = await download_file(file_url, file_name)
            if filepath:
                try:
                    # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ² ÑÑ‚Ğ¸Ğ»Ğµ JARVIS
                    caption = msg_file_caption(file_name)
                    await message.answer_document(FSInputFile(filepath, filename=file_name), caption=caption)
                    files_sent += 1
                    stats["files_sent"] += 1
                    # ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ¿Ğ°ÑƒĞ·Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸
                    await asyncio.sleep(0.5)
                except Exception as e:
                    logger.error(f"Error sending file: {e}")
                finally:
                    try:
                        os.remove(filepath)
                    except:
                        pass
    
    # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    await message.answer(msg_delivery_complete(domain, files_sent, elapsed_str), reply_markup=get_main_keyboard())
    await state.clear()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ Ğ’Ğ«Ğ‘ĞĞ Ğ Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢ĞĞ’
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.callback_query(F.data.startswith("toggle_doc_"))
async def callback_toggle_doc(callback: CallbackQuery, state: FSMContext):
    """ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°"""
    doc_id = callback.data.replace("toggle_doc_", "")
    data = await state.get_data()
    selected = set(data.get("selected_docs", []))
    
    if doc_id in selected:
        selected.remove(doc_id)
    else:
        selected.add(doc_id)
    
    await state.update_data(selected_docs=list(selected))
    await callback.message.edit_reply_markup(reply_markup=get_document_selector_keyboard(selected))
    await callback.answer()

@router.callback_query(F.data == "toggle_all_docs")
async def callback_toggle_all(callback: CallbackQuery, state: FSMContext):
    """Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ/ÑĞ½ÑÑ‚ÑŒ Ğ²ÑĞµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹"""
    data = await state.get_data()
    selected = set(data.get("selected_docs", []))
    
    if len(selected) == len(SELECTABLE_DOCS):
        selected = set()  # Ğ¡Ğ½ÑÑ‚ÑŒ Ğ²ÑĞµ
    else:
        selected = set(SELECTABLE_DOCS)  # Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ
    
    await state.update_data(selected_docs=list(selected))
    await callback.message.edit_reply_markup(reply_markup=get_document_selector_keyboard(selected))
    await callback.answer()

@router.callback_query(F.data == "confirm_docs")
async def callback_confirm_docs(callback: CallbackQuery, state: FSMContext):
    """ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸"""
    data = await state.get_data()
    selected = data.get("selected_docs", [])
    
    if not selected:
        await callback.answer("âš ï¸ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ 1 Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚", show_alert=True)
        return
    
    summary = get_selected_docs_summary(set(selected))
    await callback.message.edit_text(f"""âœ… Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾ {len(selected)} Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²:

{summary}

â³ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ...""")
    await callback.answer()
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ­Ğ¢ĞĞŸ 3: Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
    await state.set_state(PresaleStates.generating_docs)
    await process_selected_documents(callback.message, state, callback.from_user.id)

@router.callback_query(F.data == "noop")
async def callback_noop(callback: CallbackQuery):
    """ĞŸÑƒÑÑ‚Ğ¾Ğ¹ callback Ğ´Ğ»Ñ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº"""
    await callback.answer()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ‘ĞĞ¢Ğ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def main():
    print(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¤– JARVIS v{VERSION} - BIMAR Presale Intelligence System       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    print(f"Manus API URL: {MANUS_BASE_URL}")
    print(f"Project ID: {MANUS_PROJECT_ID}")
    print(f"Quick Mode (default): {QUICK_MODE_DEFAULT}")
    print(f"Allowed users: {'All' if not ALLOWED_USER_IDS else ALLOWED_USER_IDS}")
    print("=" * 60)
    
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
